import{_ as dt}from"./gear-KB1inu7G.js";import{g as ct,u as et,r as p,a as lt,h as r,c as D,m as g,e,w as l,d as j,y as T,z as mt,k as a,t as m,j as pt,b as o,F as W,p as X,A as st,C as tt,n as ft}from"./index-DtepjGgS.js";import{d as F}from"./dayjs.min-B9RCbytb.js";import{a as R}from"./api-Dwt0tebd.js";import{_ as vt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{_ as _t}from"./PaginatedIterator-BwvfNgT7.js";const gt={class:"purchaseRecordAdd"},yt={class:"stat-bar mb-2"},wt={class:"text-h6"},bt={class:"text-h6"},kt={class:"font-weight-bold mb-1"},xt={class:"price-text"},$t={class:"price-text"},Dt={class:"price-text"},It={__name:"Add",props:{usingDatabase:String,useingItems:Array},emits:["getAllData"],setup(Z,{expose:O,emit:A}){const C=Z,P=A,{proxy:y}=ct(),I=et(),x=p(null),U=p(null),$=p(!1),u=p({}),S=p(""),Y=p(""),f=p(""),t=p(null),w=p([]),v=p([]),V=[n=>!!n||"不可空白"],L=[n=>!!Object.keys(n||{})[0]||"不可空白"];lt(async()=>{try{const n=await R.get("customer");if(n.length){const s=n.map(d=>({...JSON.parse(d.datalist),snkey:d.snkey}));w.value=s.map(d=>({title:d.name+" - "+d.cellphone,customerInfo:{snkey:d.snkey,name:d.name,cellphone:d.cellphone}}))}}catch(n){y.$swal({icon:"error",title:"資料庫存取錯誤!!內容:"+n})}});const b=async()=>{const{valid:n}=await x.value.validate();n?(v.value.unshift(JSON.parse(JSON.stringify(u.value))),u.value.price="",u.value.rewardPoint="",u.value.usePoint="",await tt(),x.value.reset(),U.value.focus()):y.$swal({icon:"warning",title:"資料輸入不完整!!請再次確認!!"})},z=n=>{v.value.splice(n,1)},M=async()=>{S.value="add",Y.value="新增消費資料",f.value="font-weight-black bg-error lighten-2",await tt(),x.value.reset(),u.value={Date:F().format("YYYY-MM-DD"),price:"",note:""}},J=n=>{S.value="edit",Y.value="修改消費資料",f.value="font-weight-black bg-success lighten-2",t.value=n,n.customerInfo.title||(n.customerInfo=n.customerInfo,n.customerInfo.title=n.customerInfo.text,delete n.customerInfo.text),u.value=JSON.parse(JSON.stringify(n)),$.value=!0},K=async()=>{y.$swal({title:"確認完成作業嗎?",icon:"warning",toast:!1,timer:null,showConfirmButton:!0,showCancelButton:!0,position:"center"}).then(async n=>{if(n.isConfirmed){const s=v.value.map(d=>({datalist:JSON.stringify({...d,createInfo:{name:I.state.pData.name,time:F().format("YYYY-MM-DD HH:mm:ss")}})}));try{const d=await R.options(`general/addMulti/${I.state.databaseName}/${C.usingDatabase}`,s);d.every(c=>c===!0)?(y.$swal({icon:"success",title:"已新增"}),P("getAllData"),$.value=!1,v.value=[]):(y.$swal({icon:"error",title:"新增資料過程有誤!!請再次確認!!"}),console.log("新增資料過程有誤!!請再次確認!!",d))}catch(d){y.$swal({icon:"error",title:"新增資料過程有誤!!內容:"+d})}}})},E=async()=>{const{valid:n}=await x.value.validate();if(n){u.value.editInfo||(u.value.editInfo=[]),u.value.editInfo.unshift({name:I.state.pData.name,time:F().format("YYYY-MM-DD HH:mm:ss")});const s={snkey:u.value.snkey,datalist:JSON.stringify(u.value)};try{(await I.$api.post(C.usingDatabase,s)).state==1&&(y.$swal({icon:"success",title:"已修改"}),P("getAllData"),$.value=!1)}catch(d){y.$swal({icon:"error",title:"修改失敗!!內容:"+d})}}else y.$swal({icon:"error",title:"資料輸入不完整!!請再次確認!!"})};return O({editProcess:J}),(n,s)=>{const d=r("v-icon"),k=r("v-spacer"),c=r("v-card-title"),G=r("v-autocomplete"),_=r("v-col"),N=r("v-text-field"),ot=r("v-textarea"),h=r("v-row"),nt=r("v-form"),at=r("v-card-text"),rt=r("v-divider"),q=r("v-btn"),ut=r("v-card-actions"),Q=r("v-card"),it=r("v-dialog");return g(),D("div",gt,[e(it,{modelValue:$.value,"onUpdate:modelValue":s[10]||(s[10]=i=>$.value=i),width:"auto",fullscreen:""},{activator:l(({props:i})=>[e(d,st({color:"red lighten-2",dark:""},i,{onClick:M}),{default:l(()=>[...s[11]||(s[11]=[a("mdi-plus-circle",-1)])]),_:2},1040)]),default:l(()=>[e(Q,null,{default:l(()=>[e(c,{class:mt(["d-flex",f.value])},{default:l(()=>[a(m(Y.value)+" ",1),e(k),e(d,{onClick:s[0]||(s[0]=pt(i=>$.value=!1,["stop"]))},{default:l(()=>[...s[12]||(s[12]=[a("mdi-close",-1)])]),_:1})]),_:1},8,["class"]),e(at,null,{default:l(()=>[e(nt,{ref_key:"form",ref:x},{default:l(()=>[e(h,null,{default:l(()=>[e(_,{cols:"12",sm:"4"},{default:l(()=>[e(G,{"prepend-icon":"mdi-face-man",label:"姓名 - 電話",items:w.value,modelValue:u.value.customerInfo,"onUpdate:modelValue":s[1]||(s[1]=i=>u.value.customerInfo=i),"return-object":"",rules:L,autofocus:""},null,8,["items","modelValue"])]),_:1}),e(_,{cols:"12",sm:"4"},{default:l(()=>[e(N,{label:"消費日期",type:"date","prepend-icon":"mdi-calendar",modelValue:u.value.Date,"onUpdate:modelValue":s[2]||(s[2]=i=>u.value.Date=i),rules:V},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",sm:"4"},{default:l(()=>[e(N,{ref_key:"priceInput",ref:U,type:"number",label:"消費金額","prepend-icon":"mdi-cash",modelValue:u.value.price,"onUpdate:modelValue":s[3]||(s[3]=i=>u.value.price=i),rules:V},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",sm:"4"},{default:l(()=>[e(N,{type:"number",label:"回饋點數","prepend-icon":"mdi-star-circle",modelValue:u.value.rewardPoint,"onUpdate:modelValue":s[4]||(s[4]=i=>u.value.rewardPoint=i)},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",sm:"4"},{default:l(()=>[e(N,{type:"number",label:"使用點數","prepend-icon":"mdi-minus-circle",modelValue:u.value.usePoint,"onUpdate:modelValue":s[5]||(s[5]=i=>u.value.usePoint=i)},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:l(()=>[e(ot,{label:"備註資料","prepend-icon":"mdi-note",modelValue:u.value.note,"onUpdate:modelValue":s[6]||(s[6]=i=>u.value.note=i),"auto-grow":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512)]),_:1}),e(rt),e(ut,null,{default:l(()=>[e(k),S.value=="add"?(g(),j(q,{key:0,block:"",class:"bg-primary",onClick:s[7]||(s[7]=i=>b())},{default:l(()=>[...s[13]||(s[13]=[a("確認新增",-1)])]),_:1})):T("",!0),S.value=="edit"?(g(),j(q,{key:1,class:"bg-success",onClick:s[8]||(s[8]=i=>E())},{default:l(()=>[...s[14]||(s[14]=[a("確認修改",-1)])]),_:1})):T("",!0)]),_:1}),v.value.length?(g(),j(Q,{key:0,class:"ma-4 pa-2 border-xl",border:"success sm opacity-100"},{default:l(()=>[o("div",yt,[o("div",wt,"共 "+m(v.value.length)+" 筆",1),o("div",bt," 總金額："+m(v.value.reduce((i,B)=>i+Number(B.price||0),0).toLocaleString()),1),e(q,{class:"bg-success",onClick:s[9]||(s[9]=i=>K())},{default:l(()=>[e(d,{left:""},{default:l(()=>[...s[15]||(s[15]=[a("mdi-content-save",-1)])]),_:1}),s[16]||(s[16]=a("儲存本次作業 ",-1))]),_:1})]),s[18]||(s[18]=o("hr",null,null,-1)),e(h,{class:"mt-1"},{default:l(()=>[(g(!0),D(W,null,X(v.value,(i,B)=>(g(),j(_,{cols:"12",sm:"3",md:"2",key:B},{default:l(()=>[e(Q,{class:"purchase-card pa-3 mb-3"},{default:l(()=>[o("div",kt,"日期："+m(i.Date),1),o("div",xt,"消費金額 "+m(i.price),1),o("div",$t,"回饋點數 "+m(i.rewardPoint),1),o("div",Dt,"使用點數 "+m(i.usePoint),1),o("div",null,"備註："+m(i.note),1),e(d,{class:"iconStyle",onClick:Ft=>z(B)},{default:l(()=>[...s[17]||(s[17]=[a("mdi-close",-1)])]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):T("",!0)]),_:1})]),_:1},8,["modelValue"])])}}},Vt=vt(It,[["__scopeId","data-v-a6b3fb6a"]]),Ct={class:"purchaseRecordList"},Pt={class:"title"},St={class:"text-left"},Nt={class:"text-left"},Yt={class:"text-left"},Ot={class:"text-left"},At={class:"text-left"},Ut={class:"text-left"},Mt={class:"text-left"},Jt={class:"text-left"},Bt={class:"text-left"},jt={class:"pa-0 d-flex justify-center align-center"},Ht={class:"text-truncate",style:{"max-width":"200px"}},Tt={key:0,class:"text-truncate",style:{"max-width":"500px"}},H="purchase_record",qt={__name:"index",setup(Z){const O=et(),A=p(null),C=p([]),P=p(""),y=p(""),I=p(1),x=p(10),U=[{value:5,title:"5"},{value:10,title:"10"},{value:25,title:"25"}];lt(async()=>{y.value=O.state.pData,await u()});const $=ft(()=>{const f=P.value.split(" ");let t="";return f.reduce((w,v)=>w.filter(V=>(t=JSON.stringify(V).toUpperCase(),t.includes(v.toUpperCase()))),C.value)}),u=async()=>{await R.get(H).then(f=>{let t=f.map(w=>({...JSON.parse(w.datalist),snkey:w.snkey}));C.value=t})},S=f=>{A.value.editProcess(f)},Y=async f=>{if(confirm("確認要刪除嗎? 此操作無法復原")){const w=H;f.delInfo={name:O.state.pData.name,time:F().format("YYYY-MM-DD HH:mm:ss")};const v={snkey:f.snkey,tablename:w,datalist:JSON.stringify(f)};(await R.delete(H,v)).state==1&&u()}};return(f,t)=>{const w=r("v-spacer"),v=r("v-text-field"),V=r("v-toolbar"),L=r("v-card-title"),b=r("v-icon"),z=r("v-btn"),M=r("v-list-item-title"),J=r("v-list-item"),K=r("v-list"),E=r("v-menu"),n=r("v-table"),s=r("v-card-text"),d=r("v-card");return g(),D("div",Ct,[e(d,null,{default:l(()=>[e(L,null,{default:l(()=>[e(V,{dense:"",rounded:""},{default:l(()=>[t[3]||(t[3]=o("span",{class:"mr-3 font-weight-bold"},"消費記錄管理",-1)),e(w),e(v,{class:"ml-4","hide-details":"","prepend-icon":"mdi-magnify","single-line":"",label:"搜尋",modelValue:P.value,"onUpdate:modelValue":t[0]||(t[0]=k=>P.value=k)},null,8,["modelValue"]),e(Vt,{ref_key:"childFn",ref:A,class:"ml-2",usingDatabase:H,useingItems:C.value,onGetAllData:u},null,8,["useingItems"])]),_:1})]),_:1}),e(s,null,{default:l(()=>[e(_t,{items:$.value,page:I.value,"onUpdate:page":t[1]||(t[1]=k=>I.value=k),"items-per-page":x.value,"onUpdate:itemsPerPage":t[2]||(t[2]=k=>x.value=k),"items-per-page-options":U},{default:l(({items:k})=>[e(n,{"fixed-header":"",class:"text-no-wrap","hide-default-footer":""},{default:l(()=>[o("thead",Pt,[o("tr",null,[t[22]||(t[22]=o("th",{class:"text-left"},null,-1)),o("th",St,[e(b,{small:"",color:"grey darken-2"},{default:l(()=>[...t[4]||(t[4]=[a("mdi-identifier",-1)])]),_:1}),t[5]||(t[5]=a(" 記錄ID",-1))]),o("th",Nt,[e(b,{small:"",color:"blue darken-2"},{default:l(()=>[...t[6]||(t[6]=[a("mdi-calendar",-1)])]),_:1}),t[7]||(t[7]=a(" 日期",-1))]),o("th",Yt,[e(b,{small:"",color:"indigo darken-2"},{default:l(()=>[...t[8]||(t[8]=[a("mdi-account",-1)])]),_:1}),t[9]||(t[9]=a(" 會員資訊",-1))]),o("th",Ot,[e(b,{small:"",color:"amber darken-2"},{default:l(()=>[...t[10]||(t[10]=[a("mdi-cash-multiple",-1)])]),_:1}),t[11]||(t[11]=a(" 消費金額",-1))]),o("th",At,[e(b,{small:"",color:"amber darken-2"},{default:l(()=>[...t[12]||(t[12]=[a("mdi-star-circle",-1)])]),_:1}),t[13]||(t[13]=a(" 回饋點數",-1))]),o("th",Ut,[e(b,{small:"",color:"red darken-2"},{default:l(()=>[...t[14]||(t[14]=[a("mdi-star-off",-1)])]),_:1}),t[15]||(t[15]=a(" 使用點數",-1))]),o("th",Mt,[e(b,{small:"",color:"grey darken-2"},{default:l(()=>[...t[16]||(t[16]=[a("mdi-note-text",-1)])]),_:1}),t[17]||(t[17]=a(" 備註資料",-1))]),o("th",Jt,[e(b,{small:"",color:"blue darken-2"},{default:l(()=>[...t[18]||(t[18]=[a("mdi-account-plus",-1)])]),_:1}),t[19]||(t[19]=a(" 創建紀錄",-1))]),o("th",Bt,[e(b,{small:"",color:"blue darken-2"},{default:l(()=>[...t[20]||(t[20]=[a("mdi-pencil",-1)])]),_:1}),t[21]||(t[21]=a(" 修改紀錄",-1))])])]),o("tbody",null,[(g(!0),D(W,null,X(k,(c,G)=>(g(),D("tr",{key:G},[o("td",jt,[e(E,{transition:"scale-transition","offset-y":""},{activator:l(({props:_})=>[e(z,st({variant:"text"},{ref_for:!0},_),{default:l(()=>[...t[23]||(t[23]=[o("img",{src:dt,alt:""},null,-1)])]),_:2},1040)]),default:l(()=>[e(K,null,{default:l(()=>[e(J,{onClick:_=>S(c.raw)},{default:l(()=>[e(M,null,{default:l(()=>[...t[24]||(t[24]=[a("修改",-1)])]),_:1})]),_:2},1032,["onClick"]),e(J,{onClick:_=>Y(c.raw)},{default:l(()=>[e(M,null,{default:l(()=>[...t[25]||(t[25]=[a("刪除",-1)])]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),o("td",null,m(c.raw.snkey),1),o("td",null,m(c.raw.Date),1),o("td",null,m(`${c.raw.customerInfo.customerInfo.name} -
                      ${c.raw.customerInfo.customerInfo.cellphone}`),1),o("td",null,m(c.raw.price),1),o("td",null,m(c.raw.rewardPoint),1),o("td",null,m(c.raw.usePoint),1),o("td",Ht,m(c.raw.note),1),o("td",null,m(`${c.raw.createInfo.name}(${c.raw.createInfo.time})`),1),o("td",null,[c.raw.editInfo?(g(),D("div",Tt,[(g(!0),D(W,null,X(c.raw.editInfo,(_,N)=>(g(),D("span",{key:N},m(`${_.name}(${_.time})`),1))),128))])):T("",!0)])]))),128))])]),_:2},1024)]),_:1},8,["items","page","items-per-page"])]),_:1})]),_:1})])}}};export{qt as default};

import{g as re,u as ue,r as p,a as de,c as g,e as l,w as t,h as c,b as o,y as _,j as C,k as r,d as R,i as ie,T as D,t as f,F as me,p as fe,A as ce,m as y}from"./index-DtepjGgS.js";import{_ as pe}from"./PaginatedIterator-BwvfNgT7.js";import{d as M}from"./dayjs.min-B9RCbytb.js";import{a as O}from"./api-Dwt0tebd.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ye={class:"OrderPageAdd"},be={class:"d-flex justify-space-between px-2 py-2 bg-grey-lighten-3"},ge={key:0,class:"font-weight-bold grey--text text--darken-2"},_e={key:1,class:"font-weight-bold grey--text text--darken-2"},ke={key:2,class:"font-weight-bold grey--text text--darken-2"},we={key:0,class:"pa-2"},Ve={key:0,class:"memberInfoZone"},xe={class:"bg-grey-lighten-4 rounded pa-2"},he={class:"bg-grey-lighten-4 rounded pa-2"},Ne={key:0,class:"addMemberInfoZone"},Pe={__name:"Add",props:{usingDatabase:String,showButtom:Boolean},setup(T){const{proxy:I}=re(),Y=ue(),S=p(1),j=p(10),E=[{value:5,title:"5"},{value:10,title:"10"},{value:25,title:"25"}],k=p(!1),v=p({}),H=p(""),w=[a=>!!a||"不可空白"],q=[a=>!!a||"不可空白",a=>/^[A-Z][12][0-9]{8}$/.test(a)||"身份證字號格式不正確"],G=[a=>!a||/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/.test(a)||"Email 格式不正確"],x=p(!1),A=p(null),b=p("checkAuth"),d=p({}),L=p(["先生","小姐"]),h=p([]),Q=p(null),K=p(null);de(async()=>{await Z("customer")});function W(){H.value="add",v.value={},d.value={},b.value="checkAuth",k.value=!0}function X(a){return I.$swal({title:a,icon:"question",showCancelButton:!0,showConfirmButton:!0,toast:!1,position:"center"})}function $(){if(v.value.cellphone){const a=(A.value||[]).find(e=>e.cellphone===v.value.cellphone);if(a)if(a.blacklist)I.$swal({icon:"error",title:"請聯絡服務人員唷!!"});else{b.value="memberCheckOK",v.value.customerInfo={...a};const e={key:"customerInfo.customerInfo.snkey",value:a.snkey};O.options(`byjson/searchByKeyValue/${Y.state.databaseName}/purchase_record`,e).then(i=>{i.length>0&&(h.value=i.map(s=>({...JSON.parse(s.datalist),snkey:s.snkey})))})}else X("無此會員，是否新增資料？").then(e=>{e.isConfirmed&&(b.value="addMember")})}}async function Z(a){await O.get(a).then(e=>{const i=e.map(u=>s(u.datalist)?{...JSON.parse(u.datalist),snkey:u.snkey}:"");A.value=i;function s(u){if(typeof u=="string")try{const m=JSON.parse(u);return typeof m=="object"&&m}catch(m){return alert("2資料庫存在不合法的資料,請跟工程師聯絡!!"),console.log("databaseName:",a,"error:"+u+"!!!"+m),!1}}})}async function ee(){if(K.value.validate()){if(v.value.cellphone!=d.value.cellphone)return I.$swal({icon:"error",title:"請確認兩個手機號碼要一致唷!!"}),!1;d.value.createInfo={name:d.value.name,time:M().format("YYYY-MM-DD HH:mm:ss")};const a={datalist:JSON.stringify(d.value)};x.value=!0,await O.add("customer",a).then(async e=>{e.state&&(A.value=null,await Z("customer"),$(),x.value=!1)})}}function N(a){const e=M();return h.value.reduce((i,s)=>{if(!s.price||!s.Date)return i;const u=M(s.Date);if(a==="year"){if(u.year()===e.year())return i+Number(s.price)}else if(a==="lastyear"){if(u.year()===e.year()-1)return i+Number(s.price)}else if(a==="month"){if(u.year()===e.year()&&u.month()===e.month())return i+Number(s.price)}else return i+Number(s.price);return i},0)}function P(a){return h.value.reduce((e,i)=>e+Number(i[a]||0),0)}return(a,e)=>{const i=c("v-btn"),s=c("v-icon"),u=c("v-text-field"),m=c("v-col"),B=c("v-row"),U=c("v-divider"),le=c("v-table"),te=c("v-select"),F=c("v-card-text"),ne=c("v-spacer"),oe=c("v-card-actions"),J=c("v-card"),z=c("v-form"),ae=c("v-dialog");return y(),g("div",ye,[l(ae,{modelValue:k.value,"onUpdate:modelValue":e[15]||(e[15]=n=>k.value=n),scrollable:"",transition:"scroll-y-reverse-transition",fullscreen:b.value!="checkAuth"},{activator:t(({props:n})=>[l(D,{name:"slide-fade",mode:"out-in"},{default:t(()=>[T.showButtom?(y(),R(i,ce({key:0,class:"titleFontColor text-white",color:"#32435F",size:"x-large",onClick:e[0]||(e[0]=V=>W())},n),{default:t(()=>[...e[16]||(e[16]=[r("會員登入",-1)])]),_:2},1040)):_("",!0)]),_:2},1024)]),default:t(()=>[l(J,null,{default:t(()=>[o("div",be,[e[18]||(e[18]=o("div",null,"　",-1)),b.value=="checkAuth"?(y(),g("h3",ge," 會員登入 ")):_("",!0),b.value=="addMember"?(y(),g("h3",_e," 新增會員資料 ")):_("",!0),b.value=="memberCheckOK"?(y(),g("h3",ke," 會員資料及相關記錄 ")):_("",!0),l(s,{onClick:e[1]||(e[1]=C(n=>k.value=!1,["stop"]))},{default:t(()=>[...e[17]||(e[17]=[r("mdi-close",-1)])]),_:1})]),l(F,{class:"pa-1"},{default:t(()=>[l(z,{ref_key:"form",ref:Q},{default:t(()=>[b.value=="checkAuth"?(y(),g("div",we,[k.value?(y(),R(u,{key:0,type:"number",label:"請輸入手機號碼","prepend-inner-icon":"mdi-cellphone",modelValue:v.value.cellphone,"onUpdate:modelValue":e[2]||(e[2]=n=>v.value.cellphone=n),rules:w,autofocus:"",onKeydown:e[3]||(e[3]=ie(C(n=>$(),["prevent"]),["enter"]))},null,8,["modelValue"])):_("",!0),l(i,{class:"bg-grey ml-2",onClick:e[4]||(e[4]=C(n=>$(),["stop"])),block:""},{default:t(()=>[...e[19]||(e[19]=[r("確認",-1)])]),_:1})])):_("",!0),l(D,{name:"slide-fade2",mode:"out-in"},{default:t(()=>[b.value=="memberCheckOK"?(y(),g("div",Ve,[o("div",xe,[e[30]||(e[30]=o("h3",null,"會員資料",-1)),e[31]||(e[31]=o("hr",null,null,-1)),l(B,{class:"mt-1"},{default:t(()=>[l(m,{cols:"12",sm:"4"},{default:t(()=>[o("h3",null,[l(s,{color:"indigo-darken-2"},{default:t(()=>[...e[20]||(e[20]=[r("mdi-account",-1)])]),_:1}),r(" "+f(v.value.customerInfo.name)+" "+f(v.value.customerInfo.sex),1)])]),_:1}),l(m,{cols:"12",sm:"4"},{default:t(()=>[o("h3",null,[l(s,{color:"teal-darken-2"},{default:t(()=>[...e[21]||(e[21]=[r("mdi-cellphone",-1)])]),_:1}),r(" "+f(v.value.customerInfo.cellphone),1)])]),_:1}),l(m,{cols:"12",sm:"4"},{default:t(()=>[o("h3",null,[l(s,{color:"amber-darken-2"},{default:t(()=>[...e[22]||(e[22]=[r("mdi-medal",-1)])]),_:1}),r(" "+f(v.value.customerInfo.level),1)])]),_:1})]),_:1}),l(U,{class:"my-2"}),l(B,null,{default:t(()=>[l(m,{cols:"12",sm:"3"},{default:t(()=>[o("h3",null,[l(s,{color:"amber-darken-2"},{default:t(()=>[...e[23]||(e[23]=[r("mdi-cash-multiple",-1)])]),_:1}),r(" 總消費金額："+f(N("total")),1)])]),_:1}),l(m,{cols:"12",sm:"3"},{default:t(()=>[o("h3",null,[l(s,{color:"warning-darken-2"},{default:t(()=>[...e[24]||(e[24]=[r("mdi-calendar-range",-1)])]),_:1}),r(" 去年度消費金額："+f(N("lastyear")),1)])]),_:1}),l(m,{cols:"12",sm:"3"},{default:t(()=>[o("h3",null,[l(s,{color:"blue-darken-2"},{default:t(()=>[...e[25]||(e[25]=[r("mdi-calendar-range",-1)])]),_:1}),r(" 本年度消費金額："+f(N("year")),1)])]),_:1}),l(m,{cols:"12",sm:"3"},{default:t(()=>[o("h3",null,[l(s,{color:"green-darken-2"},{default:t(()=>[...e[26]||(e[26]=[r("mdi-calendar-month",-1)])]),_:1}),r(" 本月消費金額："+f(N("month")),1)])]),_:1})]),_:1}),l(B,null,{default:t(()=>[l(m,{cols:"12",sm:"4"},{default:t(()=>[o("h3",null,[l(s,{color:"amber-darken-2"},{default:t(()=>[...e[27]||(e[27]=[r("mdi-star-circle",-1)])]),_:1}),r(" 總回饋點數："+f(P("rewardPoint")),1)])]),_:1}),l(m,{cols:"12",sm:"4"},{default:t(()=>[o("h3",null,[l(s,{color:"red-darken-2"},{default:t(()=>[...e[28]||(e[28]=[r("mdi-star-off",-1)])]),_:1}),r(" 已使用點數："+f(P("usePoint")),1)])]),_:1}),l(m,{cols:"12",sm:"4"},{default:t(()=>[o("h3",null,[l(s,{color:"green-darken-2"},{default:t(()=>[...e[29]||(e[29]=[r("mdi-star",-1)])]),_:1}),r(" 剩餘點數："+f(P("rewardPoint")-P("usePoint")),1)])]),_:1})]),_:1})]),l(U,{class:"my-2"}),o("div",he,[e[33]||(e[33]=o("h3",null,"消費記錄",-1)),l(U,{class:"mb-2"}),l(pe,{items:h.value,page:S.value,"onUpdate:page":e[5]||(e[5]=n=>S.value=n),"items-per-page":j.value,"onUpdate:itemsPerPage":e[6]||(e[6]=n=>j.value=n),"items-per-page-options":E},{default:t(({items:n})=>[l(le,{"fixed-header":"",class:"text-no-wrap"},{default:t(()=>[e[32]||(e[32]=o("thead",{class:"title"},[o("tr",null,[o("th",{class:"text-left"},"日期"),o("th",{class:"text-left"},"消費金額"),o("th",{class:"text-left"},"回饋點數"),o("th",{class:"text-left"},"使用點數")])],-1)),o("tbody",null,[(y(!0),g(me,null,fe(n,(V,se)=>(y(),g("tr",{key:se},[o("td",null,f(V.raw.Date),1),o("td",null,f(V.raw.price),1),o("td",null,f(V.raw.rewardPoint),1),o("td",null,f(V.raw.usePoint),1)]))),128))])]),_:2},1024)]),_:1},8,["items","page","items-per-page"])])])):_("",!0)]),_:1}),l(D,{name:"slide-fade2",mode:"out-in"},{default:t(()=>[b.value=="addMember"?(y(),g("div",Ne,[l(z,{ref_key:"addnewmember",ref:K},{default:t(()=>[l(J,{classs:"bg-grey-lighten-4"},{default:t(()=>[l(F,null,{default:t(()=>[l(u,{type:"number",label:"請再次輸入手機號碼(必填)","prepend-inner-icon":"mdi-cellphone",modelValue:d.value.cellphone,"onUpdate:modelValue":e[7]||(e[7]=n=>d.value.cellphone=n),rules:w,autofocus:""},null,8,["modelValue"]),l(u,{label:"請輸入姓名(必填)","prepend-inner-icon":"mdi-face-man",modelValue:d.value.name,"onUpdate:modelValue":e[8]||(e[8]=n=>d.value.name=n),rules:w},null,8,["modelValue"]),l(te,{label:"稱謂(必選)","prepend-inner-icon":"mdi-account",items:L.value,modelValue:d.value.sex,"onUpdate:modelValue":e[9]||(e[9]=n=>d.value.sex=n),rules:w},null,8,["items","modelValue"]),l(u,{label:"身份證字號(必填)","prepend-inner-icon":"mdi-card-account-details",modelValue:d.value.idNumber,"onUpdate:modelValue":e[10]||(e[10]=n=>d.value.idNumber=n),rules:q},null,8,["modelValue"]),l(u,{label:"生日 用於生日禮優惠(必填)","prepend-inner-icon":"mdi-cake-variant",type:"date",modelValue:d.value.birthday,"onUpdate:modelValue":e[11]||(e[11]=n=>d.value.birthday=n),rules:w},null,8,["modelValue"]),l(u,{label:"請輸入IG帳號/FB名字","prepend-inner-icon":"mdi-account-circle",modelValue:d.value.socialName,"onUpdate:modelValue":e[12]||(e[12]=n=>d.value.socialName=n)},null,8,["modelValue"]),l(u,{label:"Email 信箱","prepend-inner-icon":"mdi-email",type:"email",modelValue:d.value.email,"onUpdate:modelValue":e[13]||(e[13]=n=>d.value.email=n),rules:G},null,8,["modelValue"])]),_:1}),l(oe,null,{default:t(()=>[l(ne),l(i,{class:"bg-primary",onClick:e[14]||(e[14]=C(n=>ee(),["stop"])),loading:x.value,disabled:x.value},{default:t(()=>[...e[34]||(e[34]=[r("確認新增",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1},512)])):_("",!0)]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["modelValue","fullscreen"])])}}},Ue=ve(Pe,[["__scopeId","data-v-18d9ed82"]]);export{Ue as p};

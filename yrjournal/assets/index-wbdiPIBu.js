import{d as k}from"./dayjs.min-B9RCbytb.js";import{p as A}from"./Add-DLyeg4nt.js";import{c as u,e as n,b as m,h as l,z as b,t as f,w as d,F as M,p as w,m as c,d as $,y as x,k as _,j as I,T as R}from"./index-DtepjGgS.js";import{_ as U}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./api-Dwt0tebd.js";import"./PaginatedIterator-BwvfNgT7.js";const j={components:{EditOrder:A},props:["usingDatabase","time","orderItems","ordersetItems","index"],data(){return{tables:[]}},computed:{returnTotal(){return this.matchItems.reduce((t,e)=>e.canceled?t:t+=parseInt(e.adult)+parseInt(e.children),0)},matchItems(){let t=this.orderItems.filter(e=>e.timeInfo.time==this.time);return t.forEach(e=>{let s=this.customerItems.find(i=>i.snkey==e.customerInfo.snkey);s&&(e.customerInfo=s)}),t},customerItems(){return this.$store.state.customerItems.map(t=>({...JSON.parse(t.datalist),snkey:t.snkey}))}},mounted(){this.changeTables()},methods:{returnMatchInfo(t){let e=this.$store.state.usingItems.filter(s=>{if(JSON.stringify(s).includes(t.customerInfo.cellphone))return s});return e=e.map(s=>JSON.parse(s.datalist)).sort((s,i)=>s.Date>i.Date?1:-1).filter(s=>s.Date<t.Date&&!s.canceled),e.length?e.pop():""},returnRealOrderset(t){return this.ordersetItems.find(e=>t.time===e.time&&t.week===e.week)},serviceEmployeeChecked(t){this.yn("確認接待人員?").then(e=>{if(e.isConfirmed){let s="orderinfo";t.delInfo={name:this.$store.state.pData.name,time:k().format("YYYY-MM-DD HH:mm:ss")};let i={snkey:t.snkey,datalist:JSON.stringify(t)};this.$api.post(s,i).then(async r=>{r.state==1&&(this.$confirm("接待人員資料已存檔",t),this.$store.dispatch("getUsingItems","orderinfo"),this.$store.commit("setdialogCloseable",!1))})}})},cancelOrder(t){this.yn("確認取消訂位嗎?").then(e=>{if(e.isConfirmed){var s="orderinfo";t.delInfo={name:this.$store.state.pData.name,time:k().format("YYYY-MM-DD HH:mm:ss")};let i={snkey:t.snkey,tablename:s,datalist:JSON.stringify(t)};this.$api.delete(s,i).then(async r=>{console.log("delete",r),r.state==1&&(this.$confirm("訂位已取消",t),this.$store.dispatch("getUsingItems","orderinfo"),this.$store.commit("setdialogCloseable",!1))})}})},editOrder(t){this.$refs.childFn.editProcess(t)},changeTables(t=[]){let e=[];this.matchItems.forEach(i=>{i.table&&i.table.forEach(r=>e.push(r.text))});let s=JSON.parse(this.$store.state.cData.tables).map(i=>({...i,text:`${i.name} - ${i.counts}位`})).filter(i=>!e.includes(i.text));t.forEach(i=>{s.unshift(i)}),this.tables=s},updateCustomerNote(t){let e={snkey:t.snkey,datalist:JSON.stringify(t)};this.$api.post("customer",e).then(async s=>{s.state?(this.$alert({icon:"success",title:"資料已更新"}),await this.$store.dispatch("getUsingItems",this.usingDatabase),await this.$store.dispatch("setItems","customer")):this.$alert({icon:"error",title:"資料更新失敗"})})},checkInProcess(t){t.checkIn?t.checkInTime=k().format("YYYY-MM-DD HH:mm:ss"):t.checkInTime=null;let e={snkey:t.snkey,datalist:JSON.stringify(t)};this.$api.post(this.usingDatabase,e).then(s=>{s.state?(this.$alert({icon:"success",title:"資料已更新"}),this.$emit("getAllData")):this.$alert({icon:"error",title:"資料更新失敗"})})},recoveryState(t){this.yn("確認回復取消訂位嗎?").then(e=>{if(e.isConfirmed){delete t.canceled;let s={snkey:t.snkey,datalist:JSON.stringify(t)};this.$api.post(this.usingDatabase,s).then(i=>{i.state?(this.$confirm("訂位已回復",t),this.$store.dispatch("getUsingItems","orderinfo"),this.$store.commit("setdialogCloseable",!1)):this.$alert({icon:"error",title:"資料更新失敗"})})}})}}},H={class:"TimeZone"},B={class:"pa-2 rounded"},G={class:"white--text text-sm-h5 d-sm-flex font-weight-bold"},Z={key:0,class:"red px-1 rounded"},L={key:0,class:"white--text mr-2 text-h6 px-4 pt-3"},z={class:"d-flex justify-space-between"},q={key:0,class:"text-h6"},K={class:"d-sm-flex justify-space-between"},Q={key:0},W={class:"mt-2 mt-sm-0"},X={class:"mr-4 mt-2 mt-sm-0"},ee={class:"mt-2 mt-sm-0 text-sm-h6"},te={key:0,class:"text-sm-h6"},se={class:"d-flex"},ne={key:0},oe={class:"d-sm-flex align-center justify-space-between text-no-wrap mt-1"},ae={class:"d-sm-flex align-center justify-space-between"},re={class:"d-flex"},le={class:"d-flex"};function ie(t,e,s,i,r,a){const V=l("EditOrder"),C=l("v-spacer"),D=l("v-divider"),y=l("v-btn"),S=l("v-expansion-panel-header"),Y=l("v-checkbox"),O=l("v-icon"),v=l("v-text-field"),g=l("v-chip"),N=l("v-select"),p=l("v-textarea"),T=l("v-expansion-panel-content"),E=l("v-expansion-panel"),J=l("v-expansion-panels");return c(),u("div",H,[n(V,{ref:"childFn"},null,512),m("div",B,[m("div",G,[m("span",{class:b(s.index%2?"":"black--text")}," 用餐時段: "+f(s.time)+" 總訂單數: "+f(a.matchItems.length),3),n(C),typeof a.returnRealOrderset(a.matchItems[0].timeInfo)>"u"?(c(),u("span",Z,"本時段未設定")):(c(),u("span",{key:1,class:b(a.returnRealOrderset(a.matchItems[0].timeInfo).maxUsers-a.returnTotal<=0?"white--text error rounded px-2":"")},"#剩餘可訂位 "+f(a.returnRealOrderset(a.matchItems[0].timeInfo).maxUsers-a.returnTotal)+" (目前: "+f(a.returnTotal)+" / 最大: "+f(a.returnRealOrderset(a.matchItems[0].timeInfo).maxUsers)+" ) ",3))]),n(D,{class:"white my-1"}),n(J,null,{default:d(()=>[(c(!0),u(M,null,w(a.matchItems,(o,F)=>(c(),$(E,{key:F,class:b(o.canceled?"error lighten-1":"")},{default:d(()=>[o.canceled?(c(),u("div",L,[e[1]||(e[1]=_("#已取消訂位 ",-1)),m("div",z,[o.cancelTime?(c(),u("span",q,"[ "+f(o.cancelTime)+" ] ",1)):x("",!0),n(y,{"x-small":"",onClick:I(h=>a.recoveryState(o),["stop"])},{default:d(()=>[...e[0]||(e[0]=[_("回復",-1)])]),_:2},1032,["onClick"])]),n(D)])):x("",!0),n(S,{class:"text-sm-h5"},{default:d(()=>[m("div",null,[m("div",K,[m("div",null,[o.createInfo?(c(),u("div",Q,"訂位時間: "+f(o.createInfo.time),1)):x("",!0),m("div",W,"姓名: "+f(o.customerInfo.name)+" 電話: "+f(o.customerInfo.cellphone),1)]),m("div",X," 大人: "+f(o.adult?o.adult:0)+"位 小孩: "+f(o.children?o.children:0)+"位 ",1)]),m("div",ee,f(a.returnMatchInfo(o)!=""?"近期用餐日:"+a.returnMatchInfo(o).Date:""),1),o.note?(c(),u("div",te,[n(D,{class:"my-2"}),_(" 其他需求: "+f(o.note),1)])):x("",!0)])]),_:2},1024),n(T,null,{default:d(()=>[m("div",se,[n(Y,{"hide-details":"",class:"ma-0 pa-0",label:"報到",modelValue:o.checkIn,"onUpdate:modelValue":h=>o.checkIn=h,onClick:h=>a.checkInProcess(o)},null,8,["modelValue","onUpdate:modelValue","onClick"]),o.checkIn?(c(),u("span",ne,"[ "+f(o.checkInTime)+" ]",1)):x("",!0),n(Y,{"hide-details":"",class:"ma-0 pa-0 ml-4",label:"黑名單",modelValue:o.customerInfo.blacklist,"onUpdate:modelValue":h=>o.customerInfo.blacklist=h,onChange:h=>a.updateCustomerNote(o.customerInfo)},null,8,["modelValue","onUpdate:modelValue","onChange"]),n(y,{text:"",small:"",onClick:I(h=>a.editOrder(o),["stop"])},{default:d(()=>[n(O,{color:"green"},{default:d(()=>[...e[2]||(e[2]=[_("mdi-pencil",-1)])]),_:1})]),_:2},1032,["onClick"]),n(y,{text:"",small:"",onClick:I(h=>a.cancelOrder(o),["stop"])},{default:d(()=>[n(O,{color:"red"},{default:d(()=>[...e[3]||(e[3]=[_("mdi-close",-1)])]),_:1})]),_:2},1032,["onClick"]),n(v,{label:"接待人員",modelValue:o.serviceEmployee,"onUpdate:modelValue":h=>o.serviceEmployee=h,"hide-details":"",class:"pa-0 ma-0 ml-3",style:{"max-width":"200px"}},null,8,["modelValue","onUpdate:modelValue"]),n(y,{class:"success ml-1",small:"",onClick:I(h=>a.serviceEmployeeChecked(o),["stop"])},{default:d(()=>[...e[4]||(e[4]=[_("接待人員確認",-1)])]),_:2},1032,["onClick"])]),m("div",oe,[m("div",ae,[m("div",re,[(c(!0),u(M,null,w(o.table,(h,P)=>(c(),$(g,{class:"grey",key:P},{default:d(()=>[_(f(h.text),1)]),_:2},1024))),128))])]),n(C),n(N,{label:"安排坐位","prepend-icon":"mdi-check-circle-outline",items:r.tables,modelValue:o.table,"onUpdate:modelValue":h=>o.table=h,style:{"max-width":"50%"},dense:"","hide-details":"",clearable:"",multiple:"","return-object":"",onClick:I(h=>a.changeTables(o.table),["stop"]),onChange:h=>a.checkInProcess(o)},null,8,["items","modelValue","onUpdate:modelValue","onClick","onChange"])]),m("div",le,[n(p,{dense:"",rows:"1",label:"店內備註",class:b({"rounded mt-4 amber lighten-3":o.customerInfo.note}),modelValue:o.customerInfo.note,"onUpdate:modelValue":h=>o.customerInfo.note=h,"auto-grow":"","hide-details":""},null,8,["class","modelValue","onUpdate:modelValue"]),n(y,{class:"warning align-self-end ml-5",onClick:I(h=>a.updateCustomerNote(o.customerInfo),["stop"]),small:""},{default:d(()=>[...e[5]||(e[5]=[_("更新店內備註",-1)])]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1032,["class"]))),128))]),_:1})])])}const de=U(j,[["render",ie]]),ce={components:{TimeZone:de,EditOrder:A},props:["usingDatabase"],data(){return{dialog:!1,list:{},orderItems:null,timeArr:[],emptyRules:[t=>!!t||"不可空白"],ordersetItems:null}},async mounted(){await this.$api.get("orderset").then(t=>{this.ordersetItems=t.map(e=>({...JSON.parse(e.datalist),snkey:e.snkey}))})},methods:{addOrder(){this.$refs.childFn.backAddProcess(this.list.day)},editProcess(t){this.list=JSON.parse(JSON.stringify(t)),this.orderItems=this.list.orderItems.sort((s,i)=>s.timeInfo.time>i.timeInfo.time?1:-1);let e=[];this.orderItems.forEach(s=>{e.push(s.timeInfo.time)}),this.timeArr=[...new Set(e)],this.timeArr.sort((s,i)=>s>i?1:-1),this.$store.commit("setdialogCloseable",!0),this.dialog=!0}}},me={class:"OrderinfoAdd"},ue={class:"text-sm-h4 font-weight-bold"},he={key:0};function fe(t,e,s,i,r,a){const V=l("EditOrder"),C=l("v-spacer"),D=l("v-btn"),y=l("v-icon"),S=l("v-card-title"),Y=l("v-divider"),O=l("TimeZone"),v=l("v-card-text"),g=l("v-card"),N=l("v-dialog");return c(),u("div",me,[n(V,{ref:"childFn"},null,512),n(N,{modelValue:r.dialog,"onUpdate:modelValue":e[2]||(e[2]=p=>r.dialog=p),fullscreen:"",persistent:t.$store.state.dialogCloseable},{default:d(()=>[n(g,{class:"grey lighten-4"},{default:d(()=>[n(S,null,{default:d(()=>[m("div",ue,f(r.list.day)+" 訂位一覽",1),n(C),n(D,{class:"primary mr-2",small:"",onClick:e[0]||(e[0]=p=>a.addOrder())},{default:d(()=>[...e[3]||(e[3]=[_("新增訂位",-1)])]),_:1}),n(y,{onClick:e[1]||(e[1]=p=>r.dialog=!1)},{default:d(()=>[...e[4]||(e[4]=[_("mdi-close",-1)])]),_:1})]),_:1}),n(Y),n(v,{class:"pa-2"},{default:d(()=>[(c(!0),u(M,null,w(r.timeArr,(p,T)=>(c(),$(O,{index:T,key:p,time:p,usingDatabase:s.usingDatabase,ordersetItems:r.ordersetItems,orderItems:r.orderItems,class:b(["grey lighten-1 pa-2 mb-10 rounded",T%2?"darken-3":""])},null,8,["index","time","usingDatabase","ordersetItems","orderItems","class"]))),128)),r.timeArr.length?x("",!0):(c(),u("h2",he,"暫無資料..."))]),_:1})]),_:1})]),_:1},8,["modelValue","persistent"])])}const pe=U(ce,[["render",fe]]),_e={components:{popupadd:pe},data(){return{usingDatabase:"orderinfo",weekContentItems:["日","一","二","三","四","五","六"],emptyRules:[t=>!!t||"不可空白"],holidaySet:"",today:k().format("YYYY-MM-DD"),month:k().format("YYYY-MM"),items:null}},computed:{dataReady(){if(this.dateArr){let t=this.dateArr.map(e=>({day:e,orderItems:this.matchDayContent(e)}));return this.items=t,!0}else return!1},dateArr(){let t=[];for(let e=0;e<42;e++){let s=k(this.firstDay).add(e,"day").format("YYYY-MM-DD");t.push(s)}return t},firstDay(){let t=k(this.month).format("YYYY-MM-01"),e=k(t).format("d");return k(t).add(-e,"day").format("YYYY-MM-DD")},filtervactionItemsForThisMan(){return this.vactionItems.filter(t=>t.personnel_id==this.$store.state.pData.id)},orderInfoItems(){return this.$store.state.usingItems.map(e=>t(e.datalist)?{...JSON.parse(e.datalist),snkey:e.snkey}:"");function t(e){if(typeof e=="string")try{var s=JSON.parse(e);return!!(typeof s=="object"&&s)}catch(i){return alert("1資料庫存在不合法的資料,請跟工程師聯絡!!"),console.log("error："+e+"!!!"+i),!1}}}},async mounted(){this.holidaySet=JSON.parse(this.$store.state.cData.holidaySet),await this.getAllData(),await this.getCustomer()},methods:{async getCustomer(){await this.$store.dispatch("setItems","customer")},addProcess(t){this.$refs.childFn.editProcess(t)},async getAllData(){await this.$store.dispatch("getUsingItems",this.usingDatabase)},matchDayContent(t){return this.orderInfoItems.filter(e=>e.Date==t)},checkThisMonth(t){return!t.includes(this.month)},setThisMonth(){this.month=k().format("YYYY-MM")},setMonth(t){this.month=k(this.month).add(t,"month").format("YYYY-MM")}}},ve={class:"OrderInfoList"},ye={class:"d-sm-flex"},ge={class:"d-flex align-end mt-2"},ke={class:"grey lighten-3 rounded pa-3"},Ie={class:"d-flex"},xe={key:0},be={key:0,style:{width:"100%","min-height":"12vh"},class:"d-flex"},De=["onClick"];function Ce(t,e,s,i,r,a){const V=l("popupadd"),C=l("v-spacer"),D=l("v-text-field"),y=l("v-btn"),S=l("v-card-title"),Y=l("v-card-text"),O=l("v-card");return c(),u("div",ve,[n(V,{ref:"childFn",usingDatabase:r.usingDatabase,onGetAllData:a.getAllData,onGetCustomer:a.getCustomer},null,8,["usingDatabase","onGetAllData","onGetCustomer"]),a.dataReady?(c(),$(O,{key:0},{default:d(()=>[n(S,null,{default:d(()=>[e[7]||(e[7]=m("span",{class:"font-weight-bold"},"訂位資訊",-1)),n(C),m("div",ye,[n(D,{label:"設定月份",type:"month",class:"mx-3",modelValue:r.month,"onUpdate:modelValue":e[0]||(e[0]=v=>r.month=v),"hide-details":"",mandatory:""},null,8,["modelValue"]),m("div",ge,[n(y,{onClick:e[1]||(e[1]=I(v=>a.setMonth(-1),["stop"]))},{default:d(()=>[...e[4]||(e[4]=[_("上個月",-1)])]),_:1}),n(y,{onClick:e[2]||(e[2]=I(v=>a.setThisMonth(),["stop"]))},{default:d(()=>[...e[5]||(e[5]=[_("本月",-1)])]),_:1}),n(y,{onClick:e[3]||(e[3]=I(v=>a.setMonth(1),["stop"]))},{default:d(()=>[...e[6]||(e[6]=[_("下個月",-1)])]),_:1})])])]),_:1}),n(Y,null,{default:d(()=>[m("div",ke,[m("div",Ie,[(c(!0),u(M,null,w(r.weekContentItems,v=>(c(),u("div",{key:v,class:b(["weekDay text-center font-weight-bold",r.holidaySet.includes(v)?"holiday white--text":""])},[_(" 星期"+f(v)+" ",1),r.holidaySet.includes(v)||!1?(c(),u("span",xe,"(休)")):x("",!0)],2))),128))]),n(R,{name:"slide-fade2",mode:"out-in"},{default:d(()=>[(c(),u("div",{class:"calendar-day py-2",key:r.month},[(c(!0),u(M,null,w(r.items,(v,g)=>(c(),u("div",{key:g},[g%7==0?(c(),u("div",be,[(c(),u(M,null,w(7,(N,p)=>m("div",{key:p,class:b(["weekDay day d-sm-flex justify-center align-center",[{"grey darken-3 grey--text text--lightn-4":a.checkThisMonth(r.items[g+p].day)},{weekLastDay:p%7==6}]]),onClick:I(T=>a.addProcess(r.items[g+p]),["stop"])},[n(y,{icon:"",small:"",class:b(["ml-2 text-sm-h6 font-weight-bold",{"primary ma-1 white--text pa-sm-6":r.items[g+p].day==r.today}])},{default:d(()=>[_(f(r.items[g+p].day.split("-")[2]),1)]),_:2},1032,["class"]),m("div",{class:b(["text-sm-h6 text-center",{"error--text":r.items[g+p].orderItems.length}])},"("+f(r.items[g+p].orderItems.length)+") ",3)],10,De)),64))])):x("",!0)]))),128))]))]),_:1})])]),_:1})]),_:1})):x("",!0)])}const Te=U(_e,[["render",Ce],["__scopeId","data-v-b967c233"]]);export{Te as default};

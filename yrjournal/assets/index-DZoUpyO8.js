import{u as ne,r as p,n as T,h as o,c as C,m,e,w as t,j as E,k as g,A as re,g as ie,z as J,t as h,b as c,F as q,p as Q,d as b,y as x,C as de,a as me}from"./index-DtepjGgS.js";import{_ as ve}from"./gear-KB1inu7G.js";import{d as W}from"./dayjs.min-B9RCbytb.js";import{a as M}from"./api-Dwt0tebd.js";import{_ as pe}from"./PaginatedIterator-BwvfNgT7.js";const _e={__name:"showBigpic",props:{item:Object,folder:String},setup(j){const D=j,P=ne(),_=p(!1),U=T(()=>`${P.state.base_url}/upload/${D.folder}/`);return(I,v)=>{const V=o("v-img"),s=o("v-icon"),B=o("v-btn"),w=o("v-card-title"),k=o("v-card-text"),S=o("v-card"),A=o("v-dialog");return m(),C("div",null,[e(A,{modelValue:_.value,"onUpdate:modelValue":v[2]||(v[2]=Y=>_.value=Y),width:"auto",scrollable:"",fullscreen:"",transition:"dialog-bottom-transition"},{activator:t(({props:Y})=>[e(V,re({src:U.value+j.item.picName,"lazy-src":U.value+"lazypic.jpg","aspect-ratio":"1",class:"d-flex align-end",width:"100%"},Y),null,16,["src","lazy-src"])]),default:t(()=>[e(S,{class:"black"},{default:t(()=>[e(w,null,{default:t(()=>[e(B,{icon:"",large:"",dark:"",class:"mt-1",onClick:v[0]||(v[0]=E(Y=>_.value=!_.value,["stop"]))},{default:t(()=>[e(s,null,{default:t(()=>[...v[3]||(v[3]=[g("mdi-close",-1)])]),_:1})]),_:1})]),_:1}),e(k,null,{default:t(()=>[e(V,{class:"mt-1",src:U.value+j.item.picName,"lazy-src":U.value+"lazypic.jpg","aspect-ratio":"1",width:"100%",onClick:v[1]||(v[1]=E(Y=>_.value=!_.value,["stop"]))},null,8,["src","lazy-src"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},fe={class:"personneladd"},ke={class:"d-flex pa-2"},ye={__name:"Add",props:{usingDatabase:String,personnelItems:Array,authKeys:Array},emits:["getAllData"],setup(j,{expose:D,emit:P}){const{proxy:_}=ie(),U=ne(),I=j,v=P,V=p(!1),s=p({}),B=p(""),w=p(""),k=p(""),S=p(null),A=[d=>!!d||"不可空白"],Y=T(()=>I.authKeys.filter(d=>d.authKey!="pass")),L=T(()=>{let d={};for(let n of Y.value)d[`${n.keyName}_key`]="",d[`${n.keyName}_add_key`]="",d[`${n.keyName}_edit_key`]="",d[`${n.keyName}_del_key`]="",d[`${n.keyName}_search_key`]="";return d}),X=()=>{B.value="add",w.value="新增人員資料",k.value="font-weight-black bg-error lighten-2",s.value={...L.value},de(()=>{S.value.resetValidation()})},H=d=>{B.value="edit",w.value="修改人員資料",k.value="font-weight-black bg-success lighten-2",s.value={...d},V.value=!0},Z=async()=>{if(I.personnelItems.find(a=>a.account==s.value.account))return _.$swal({icon:"error",title:"登入帳號不可重覆!!"}),!1;const{valid:n}=await S.value.validate();if(n){s.value.createInfo={name:U.state.pData.name,time:W().format("YYYY-MM-DD HH:mm:ss")};const a={datalist:JSON.stringify(s.value)};try{(await M.add(I.usingDatabase,a)).state==1&&(_.$swal({icon:"success",title:"已新增"}),v("getAllData"),V.value=!1)}catch(l){_.$swal({icon:"error",title:"資料存取錯誤!!內容:"+l})}}else _.$swal({icon:"error",title:"資料輸入不完整!!請再次確認!!"})},K=async()=>{const{valid:d}=await S.value.validate();if(d){s.value.editInfo||(s.value.editInfo=[]),s.value.editInfo.unshift({name:U.state.pData.name,time:W().format("YYYY-MM-DD HH:mm:ss")});const n={snkey:s.value.snkey,datalist:JSON.stringify(s.value)};(await M.post(I.usingDatabase,n)).state==1&&(_.$swal({icon:"success",title:"已修改,權限相關功能將在重新登入後生效"}),v("getAllData"),V.value=!1)}else _.$swal({icon:"error",title:"資料輸入不完整!!請再次確認!!"})},ee=()=>{for(let d in s.value)d.includes("_key")&&(s.value[d]="true")},te=()=>{for(let d in s.value)d.includes("_key")&&(s.value[d]="")};return D({editProcess:H}),(d,n)=>{const a=o("v-icon"),l=o("v-card-title"),y=o("v-text-field"),f=o("v-col"),$=o("v-row"),F=o("v-spacer"),N=o("v-btn"),z=o("v-checkbox"),G=o("v-divider"),R=o("v-alert"),le=o("v-form"),O=o("v-card-text"),ae=o("v-card-actions"),se=o("v-card"),oe=o("v-dialog");return m(),C("div",fe,[e(oe,{modelValue:V.value,"onUpdate:modelValue":n[3]||(n[3]=r=>V.value=r),width:"auto"},{activator:t(({props:r})=>[e(a,re({color:"red"},r,{onClick:X}),{default:t(()=>[...n[4]||(n[4]=[g("mdi-plus-circle",-1)])]),_:2},1040)]),default:t(()=>[e(se,null,{default:t(()=>[e(l,{class:J(k.value),"primary-title":""},{default:t(()=>[g(h(w.value),1)]),_:1},8,["class"]),e(O,null,{default:t(()=>[e(le,{ref_key:"form",ref:S},{default:t(()=>[e($,null,{default:t(()=>[e(f,{cols:"12",md:"4"},{default:t(()=>[e(y,{label:"登入授權帳號","prepend-icon":"mdi-codepen",modelValue:s.value.account,"onUpdate:modelValue":n[0]||(n[0]=r=>s.value.account=r),rules:A,autofocus:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"4"},{default:t(()=>[e(y,{label:"登入密碼","prepend-icon":"mdi-key-variant",modelValue:s.value.password,"onUpdate:modelValue":n[1]||(n[1]=r=>s.value.password=r),rules:A,reauired:""},null,8,["modelValue"])]),_:1}),e(f,{cols:"12",md:"4"},{default:t(()=>[e(y,{label:"姓名","prepend-icon":"mdi-account",modelValue:s.value.name,"onUpdate:modelValue":n[2]||(n[2]=r=>s.value.name=r),rules:A},null,8,["modelValue"])]),_:1})]),_:1}),e(R,{border:"start","border-color":"primary",elevation:"2",class:"bg-grey-lighten-4"},{default:t(()=>[c("div",ke,[n[7]||(n[7]=c("header",{class:"text-primary font-weight-bold"},"權限設定",-1)),e(F),e(N,{class:"mx-2 text-white",color:"light-blue-darken-3",size:"small",variant:"flat",onClick:E(ee,["stop"])},{default:t(()=>[...n[5]||(n[5]=[g("全選",-1)])]),_:1}),e(N,{size:"small",variant:"flat",color:"grey-lighten-1",onClick:E(te,["stop"])},{default:t(()=>[...n[6]||(n[6]=[g("全不選",-1)])]),_:1})]),e($,null,{default:t(()=>[(m(!0),C(q,null,Q(Y.value,r=>(m(),b(f,{cols:"12",md:"6",key:r.keyName},{default:t(()=>[r.keyName!="exit"?(m(),b(R,{key:0,color:r.color,text:""},{default:t(()=>[e(z,{"hide-details":"",label:r.label,modelValue:s.value[`${r.keyName}_key`],"onUpdate:modelValue":i=>s.value[`${r.keyName}_key`]=i,value:"true"},null,8,["label","modelValue","onUpdate:modelValue"]),s.value[`${r.keyName}_key`]?(m(),b($,{key:0,class:"ml-10",justify:"space-around"},{default:t(()=>[e(G),e(z,{"hide-details":"",label:"新增",modelValue:s.value[`${r.keyName}_add_key`],"onUpdate:modelValue":i=>s.value[`${r.keyName}_add_key`]=i,value:"true"},null,8,["modelValue","onUpdate:modelValue"]),e(z,{"hide-details":"",label:"修改",modelValue:s.value[`${r.keyName}_edit_key`],"onUpdate:modelValue":i=>s.value[`${r.keyName}_edit_key`]=i,value:"true"},null,8,["modelValue","onUpdate:modelValue"]),e(z,{"hide-details":"",label:"刪除",modelValue:s.value[`${r.keyName}_del_key`],"onUpdate:modelValue":i=>s.value[`${r.keyName}_del_key`]=i,value:"true"},null,8,["modelValue","onUpdate:modelValue"]),e(z,{"hide-details":"",label:"查詢",modelValue:s.value[`${r.keyName}_search_key`],"onUpdate:modelValue":i=>s.value[`${r.keyName}_search_key`]=i,value:"true"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)):x("",!0)]),_:2},1032,["color"])):x("",!0)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1},512)]),_:1}),e(G),e(ae,null,{default:t(()=>[e(F),B.value=="add"?(m(),b(N,{key:0,color:"primary",variant:"flat",class:"text-white",onClick:Z},{default:t(()=>[...n[8]||(n[8]=[g("確認新增",-1)])]),_:1})):x("",!0),B.value=="edit"?(m(),b(N,{key:1,color:"success",variant:"flat",class:"text-white",onClick:K},{default:t(()=>[...n[9]||(n[9]=[g("確認修改",-1)])]),_:1})):x("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},ge={class:"PersonnelList"},we={class:"d-flex align-center"},$e={style:{position:"relative"}},xe={class:"d-flex"},be={key:0,class:"text-truncate",style:{"max-width":"400px"}},Ie={__name:"index",setup(j){const{proxy:D}=ie(),P=ne(),_=p(null),U=p(null),I=p([]),v=p("personnel"),V=p(""),s=p(""),B=p(null),w=p(""),k=p(""),S=p(1),A=p(10),Y=[{value:5,title:"5"},{value:10,title:"10"},{value:25,title:"25"}],L=T(()=>P.state.authKeys.filter(a=>a.authKey!="exit_key")),X=T(()=>{const a=V.value.split(" ");let l="";return a.reduce((y,f)=>y.filter($=>{if(l=JSON.stringify($).toUpperCase(),l.includes(f.toUpperCase()))return $}),I.value)}),H=async()=>{await M.get(v.value).then(a=>{a.length>0&&(I.value=a.map(l=>({...JSON.parse(l.datalist),snkey:l.snkey})))})},Z=a=>{_.value.editProcess(a)},K=async a=>{D.$swal({title:"確認要刪除嗎?",text:"此操作無法復原",icon:"warning",toast:!1,timer:null,showConfirmButton:!0,showCancelButton:!0,position:"center"}).then(async l=>{if(l.isConfirmed){a.delInfo={name:P.state.pData.name,time:W().format("YYYY-MM-DD HH:mm:ss")};const y={snkey:a.snkey,tablename:v.value,datalist:JSON.stringify(a)};(await M.delete(v.value,y)).state==1&&(a.picName&&a.picName!="lazypic.jpg"&&(console.log("del process run del pic"),await n(k.value.picName)),D.$swal({icon:"success",title:"刪除成功",confirmButtonText:"確定",confirmButtonColor:"#3085d6",allowEscapeKey:!1}),await H())}})},ee=a=>{D.$swal({title:"確認更動停權設定?",icon:"warning",toast:!1,timer:null,showConfirmButton:!0,showCancelButton:!0,position:"center"}).then(l=>{if(l.isConfirmed){a.edit_man==null&&(a.edit_man=""),a.edit_man=`${P.state.pData.name}(${W().format("YYYY-MM-DD HH:mm:ss")})${a.edit_man}`;const y={snkey:a.snkey,datalist:JSON.stringify(a)};M.post(v.value,y).then(f=>{f.state==1&&(D.$swal({icon:"success",title:"已修改,權限相關功能將在重新登入後生效"}),H())})}else a.suspension===null?a.suspension="true":a.suspension=null})},te=async a=>{w.value=a.target.files[0];const l=w.value.name.split(".").pop().toLowerCase(),y=["gif","png","jpg","jpeg"];let f="";if(y.indexOf(l)==-1&&(f="檔案:"+w.value.name+"不是支持的影像檔案"),w.value.size>1024*1024*5&&(f="檔案:"+w.value.name+"不能超過5M唷"),f==""){k.value.picName&&k.value.picName!="lazypic.jpg"&&await n(k.value.picName);const $=await d();if(console.log("upload rs",$),$.state!=1){D.$swal({icon:"error",title:"上傳失敗，請聯絡系統服務商"});return}else{k.value.picName=$.picName;const F={snkey:k.value.snkey,datalist:JSON.stringify(k.value)};M.post(v.value,F),I.value.some(N=>{N.snkey==k.value.snkey&&(N.picName=$.picName)}),U.value.value=""}}else D.$swal({icon:"error",title:f}),w.value=""},d=()=>{const a=new FormData;return a.append("file",w.value),M.upload("personnel",a)},n=async a=>{const l=`general/delPic/${v.value}/${a}`,y=await M.options(l);console.log("delExistPic rs",y)};return me(async()=>{s.value=P.state.pData,await H(),B.value=`${P.state.base_url}/upload/${v.value}/`}),(a,l)=>{const y=o("v-spacer"),f=o("v-text-field"),$=o("v-card-title"),F=o("v-btn"),N=o("v-list-item-title"),z=o("v-list-item"),G=o("v-list"),R=o("v-menu"),le=o("v-checkbox"),O=o("v-chip"),ae=o("v-table"),se=o("v-card-text"),oe=o("v-card");return m(),C("div",ge,[c("input",{type:"file",accept:"image/*",ref_key:"fileInput",ref:U,onChange:te,style:{display:"none"}},null,544),e(oe,null,{default:t(()=>[e($,null,{default:t(()=>[c("div",we,[l[3]||(l[3]=c("span",{class:"mr-3"},"人員管理",-1)),e(y),e(f,{"hide-details":"","prepend-icon":"mdi-magnify","single-line":"",label:"搜尋",modelValue:V.value,"onUpdate:modelValue":l[0]||(l[0]=r=>V.value=r)},null,8,["modelValue"]),s.value.personnel_add_key?(m(),b(ye,{key:0,ref_key:"childFn",ref:_,authKeys:L.value,personnelItems:I.value,usingDatabase:v.value,class:"ml-2",onGetAllData:H},null,8,["authKeys","personnelItems","usingDatabase"])):x("",!0)])]),_:1}),e(se,null,{default:t(()=>[e(pe,{items:X.value,page:S.value,"onUpdate:page":l[1]||(l[1]=r=>S.value=r),"items-per-page":A.value,"onUpdate:itemsPerPage":l[2]||(l[2]=r=>A.value=r),"items-per-page-options":Y},{default:t(({items:r})=>[e(ae,{"fixed-header":"",class:"text-no-wrap","hide-default-footer":""},{default:t(()=>[l[12]||(l[12]=c("thead",{class:"title text-h6"},[c("tr",null,[c("th",{class:"text-left"}),c("th",{class:"text-left"},"個人照"),c("th",{class:"text-left"},"登入帳號"),c("th",{class:"text-left"},"姓名"),c("th",{class:"text-left"},"停職"),c("th",{class:"text-left"},"可用權限"),c("th",{class:"text-left"},"創建紀錄"),c("th",{class:"text-left"},"修改紀錄")])],-1)),c("tbody",null,[(m(!0),C(q,null,Q(r,(i,ue)=>(m(),C("tr",{key:ue},[c("td",null,[e(R,{transition:"scale-transition","offset-y":""},{activator:t(({props:u})=>[e(F,re({icon:""},{ref_for:!0},u),{default:t(()=>[...l[4]||(l[4]=[c("img",{src:ve,alt:""},null,-1)])]),_:2},1040)]),default:t(()=>[e(G,null,{default:t(()=>[s.value.personnel_edit_key?(m(),b(z,{key:0,onClick:u=>Z(i.raw)},{default:t(()=>[e(N,null,{default:t(()=>[...l[5]||(l[5]=[g("修改",-1)])]),_:1})]),_:2},1032,["onClick"])):x("",!0),s.value.personnel_del_key?(m(),b(z,{key:1,onClick:u=>K(i.raw)},{default:t(()=>[e(N,null,{default:t(()=>[...l[6]||(l[6]=[g("刪除",-1)])]),_:1})]),_:2},1032,["onClick"])):x("",!0),e(z,{onClick:u=>{k.value=i.raw,a.$refs.fileInput.click()}},{default:t(()=>[e(N,null,{default:t(()=>[...l[7]||(l[7]=[g("上傳圖片",-1)])]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),c("td",null,[c("div",$e,[e(_e,{item:i.raw,folder:v.value},null,8,["item","folder"])])]),c("td",null,h(i.raw.account),1),c("td",null,h(i.raw.name),1),c("td",null,[e(le,{"hide-details":"",modelValue:i.raw.suspension,"onUpdate:modelValue":u=>i.raw.suspension=u,value:"true",onClick:E(u=>ee(i.raw),["stop"])},null,8,["modelValue","onUpdate:modelValue","onClick"])]),c("td",null,[c("div",xe,[(m(!0),C(q,null,Q(L.value,u=>(m(),C("div",{key:u.label},[i.raw[`${u.keyName}_key`]?(m(),b(O,{key:0,class:J(u.class),color:u.color},{default:t(()=>[g(h(u.label),1)]),_:2},1032,["class","color"])):x("",!0),i.raw[`${u.keyName}_add_key`]?(m(),b(O,{key:1,class:J(u.class),color:u.color},{default:t(()=>[...l[8]||(l[8]=[g("增",-1)])]),_:2},1032,["class","color"])):x("",!0),i.raw[`${u.keyName}_edit_key`]?(m(),b(O,{key:2,class:J(u.class),color:u.color},{default:t(()=>[...l[9]||(l[9]=[g("修",-1)])]),_:2},1032,["class","color"])):x("",!0),i.raw[`${u.keyName}_del_key`]?(m(),b(O,{key:3,class:J(u.class),color:u.color},{default:t(()=>[...l[10]||(l[10]=[g("刪",-1)])]),_:2},1032,["class","color"])):x("",!0),i.raw[`${u.keyName}_search_key`]?(m(),b(O,{key:4,class:J(u.class),color:u.color},{default:t(()=>[...l[11]||(l[11]=[g("查",-1)])]),_:2},1032,["class","color"])):x("",!0)]))),128))])]),c("td",null,h(`${i.raw.createInfo.name}(${i.raw.createInfo.time})`),1),c("td",null,[i.raw.editInfo?(m(),C("div",be,[(m(!0),C(q,null,Q(i.raw.editInfo,(u,ce)=>(m(),C("span",{key:ce},h(`${u.name}(${u.time})`),1))),128))])):x("",!0)])]))),128))])]),_:2},1024)]),_:1},8,["items","page","items-per-page"])]),_:1})]),_:1})])}}};export{Ie as default};
